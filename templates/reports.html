{% extends "layout.html" %} {% block content %}
<h1 class="text-center" style="color: rgb(47,89,37);;font-weight: 600;font-family: Acme, sans-serif;margin-bottom: 30px;">Report Page</h1>
<div class="row">
    <div class="col-md-12">
        <div>
            <ul class="nav nav-tabs" style="text-align: center">
                <li class="active" style="float: none; display: inline-block;"><a href="#tab-1" role="tab" data-toggle="tab">EVC Received</a></li>
                <li style="float: none; display: inline-block;"><a href="#tab-2" role="tab" data-toggle="tab">Discounts Received</a></li>
                <li style="float: none; display: inline-block;"><a href="#tab-3" role="tab" data-toggle="tab">Usages Report</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" role="tabpanel" id="tab-1">
                    <section style="margin-top: 10px;">
                        <h3 class="text-center" style="color: rgb(47,89,37);font-weight: 600;font-family: Acme;line-height: 0.6;">
                            Payments Report Page
                        </h3>
                        <div class="table-responsive" style="font-size: 14px;">
                            <table class="table table-bordered" id="reports">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Billing Month</th>
                                        <th>Total Received</th>
                                        <th>Count</th>
                                        <th>Average</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>Apr-2019</td>
                                        <td>1161.20</td>
                                        <td>49</td>
                                        <td>23.70</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td class="text-right" colspan="2">Total :&nbsp;</td>
                                        <td class="text-center text-primary" colspan="1">Summary 2</td>
                                        <td class="text-center text-primary" colspan="1">Summary 2</td>
                                        <td class="text-center text-primary" colspan="1">Summary 2</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <!--
                            <div style="text-align: right; padding: 15px;">
                                <button class="btn btn-success" type="button" style="margin-right: 10px;" onclick="onBtnExport_Reports();">Export</button>
                                <button class="btn btn-info" type="button" style="margin-right: 10px;" onclick="printTableData('reports');">Print</button>
                            </div>
                            -->
                    </section>
                </div>
                <div class="tab-pane" role="tabpanel" id="tab-2">
                    <section style="margin-top: 10px;">
                        <div style="width: 120px; margin-right: 20px; display: inline-block; float: right;">
                            {{ form.months_discounted(class="form-control", **{"onchange":"reloadDiscountedTable()"}) }}
                        </div>
                        <!--
                            <div class="input-group date"  style="width: 200px;float: right;" data-date-format="M-yyyy" id="month">
                                <input  type="text" data-date-format="MMM-YYYY" class="form-control" placeholder="MMM-YYYY", id="myMonth">
                                <div class="input-group-addon" >
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </div>
                            </div>
                            -->
                        <h3 class="text-center" style="color: rgb(47,89,37);font-weight: 600;font-family: Acme;line-height: 0.6;">Discount Report Page</h3>
                        <div class="table-responsive" style="font-size: 10px; color: #000;">
                            <table class="table table-bordered" id="report_discounted_table">
                                <thead>
                                    <tr>
                                        <th style="padding: 2px 4px;">No</th>
                                        <th style="padding: 2px 4px;">Usage Id</th>
                                        <th style="padding: 2px 4px;">Supply No</th>
                                        <th style="padding: 2px 4px;">Customer</th>
                                        <th style="padding: 2px 4px;">Barcode</th>
                                        <th style="padding: 2px 4px;">Prev Read</th>
                                        <th style="padding: 2px 4px;">Curr Read</th>
                                        <th style="padding: 2px 4px;">Used KW</th>
                                        <th style="padding: 2px 4px;">Unit Rate</th>
                                        <th style="padding: 2px 4px;">Bill</th>
                                        <th style="padding: 2px 4px;">Discounted</th>
                                        <th style="padding: 2px 4px;">Biller</th>
                                        <th style="padding: 2px 4px;">Date</th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr>
                                        <td class="text-right" colspan="5">Total :&nbsp;</td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1">&nbsp;</td>
                                        <td class="text-center text-primary" colspan="1">&nbsp;</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <!--
                            <div style="text-align: right;padding: 15px;">
                                <button class="btn btn-success" type="button" style="margin-right: 10px;" onclick="onBtnExport_Discounted()">Export</button>
                                <button class="btn btn-info" type="button" style="margin-right: 10px;" onclick="printTableData('report_discounted_table');">Print</button>
                            </div>
                            -->
                    </section>
                </div>
                <div class="tab-pane" role="tabpanel" id="tab-3">
                    <section style="margin-top: 10px;">
                        <div style="text-align: right">
                            <div style="width: 120px; margin-right: 20px; display: inline-block;">
                                {{ form.isread(class="form-control", **{"onchange":"reloadUsageTable()"}) }}
                            </div>
                            <div style="width: 120px; margin-right: 20px; display: inline-block;">
                                {{ form.months_usage(class="form-control", **{"onchange":"reloadUsageTable()"}) }}
                            </div>
                        </div>
                        <h3 class="text-center" style="color: rgb(47,89,37);font-weight: 600;font-family: Acme;line-height: 0.6;">Usages Report Page</h3>
                        <div class="table-responsive" style="font-size: 10px; color: #000;">
                            <table class="table table-bordered" id="report_usage_table">
                                <thead>
                                    <tr>
                                        <th style="padding: 2px 4px;">No</th>
                                        <th style="padding: 2px 4px;">Supply No</th>
                                        <th style="padding: 2px 4px;">Name</th>
                                        <th style="padding: 2px 4px;">Barcode</th>
                                        <th style="padding: 2px 4px;">Prev Read Date</th>
                                        <th style="padding: 2px 4px;">Curr Read Date</th>
                                        <th style="padding: 2px 4px;">Prev Read</th>
                                        <th style="padding: 2px 4px;">Curr Read</th>
                                        <th style="padding: 2px 4px;">Used KW</th>
                                        <th style="padding: 2px 4px;">Unit Rate</th>
                                        <th style="padding: 2px 4px;">Discounted</th>
                                        <th style="padding: 2px 4px;">Bill</th>
                                        <th style="padding: 2px 4px;">User</th>
                                        <th style="padding: 2px 4px;">Create Date</th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr>
                                        <td class="text-right" colspan="6">Total :&nbsp;</td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1">&nbsp;</td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1"></td>
                                        <td class="text-center text-primary" colspan="1">&nbsp;</td>
                                        <td class="text-center text-primary" colspan="1">&nbsp;</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <!--
                            <div style="text-align: right;padding: 15px;">
                                <button class="btn btn-success" type="button" style="margin-right: 10px;" onclick="onBtnExport_Discounted()">Export</button>
                                <button class="btn btn-info" type="button" style="margin-right: 10px;" onclick="printTableData('report_discounted_table');">Print</button>
                            </div>
                            -->
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.0/js/bootstrap.min.js"></script>

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>

<!--
    <script language="javascript" src="https://momentjs.com/downloads/moment.js"></script>
    <script language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
-->

<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script>

<script>
    var reportTable, discountedTable, usageTable;

    /*
        $('.input-group.date').datetimepicker({
            viewMode: 'years',
            format:'MMM-YYYY',
            ignoreReadonly: true,
			defaultDate: new Date()
        }).on('dp.change', function (ev) {
			reloadDiscountedTable();
		});
    */

    function reloadDiscountedTable() {
        discountedTable.ajax.reload();
        discountedTable.draw();
    }

    function reloadUsageTable() {
        usageTable.ajax.reload();
        usageTable.draw();
    }
    
            // Remove the formatting to get integer data for summation
    var intVal = function(i) {
        return typeof i === 'string' ?
            i.replace(/[\$,]/g, '') * 1 :
            typeof i === 'number' ?
            i : 0;
    };

    function showReportTable() {
        reportTable = $('#reports').DataTable({
            pagingType: "first_last_numbers",
            ajax: {
                url: '/reports/evc',
                dataSrc: 'reportList'
            },
            columns: [{
                data: 'No'
            }, {
                data: 'BillingMonth'
            }, {
                data: 'TotalPaymentReceived'
            }, {
                data: 'NoOfPayments'
            }, {
                data: 'AveragePayment'
            }],
            dom: 'Bfrtip',
            buttons: ['print', 'excel'],
            "footerCallback": function(row, data, start, end, display) {
                var api = this.api(),
                    data;

                // Total over all pages
                totalPayments = api
                    .column(2)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);

                totalCounts = api
                    .column(3)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);

                average = parseFloat(totalPayments / totalCounts).toFixed(2);

                // Update footer
                $(api.column(2).footer()).html(
                    '$' + totalPayments
                );
                $(api.column(3).footer()).html(
                    totalCounts
                );
                $(api.column(4).footer()).html(
                    '$' + average
                );
            }
        });
        $('.dataTables_wrapper').css("font-size", "12px");
    }
    /*
    $(table.table().body()).on('click', 'tr', function () {
        var data = table.row( this ).data();
        show_month_page(data.BillingMonth);
    } );
    */

    function showDiscountedTable() {
        discountedTable = $('#report_discounted_table').DataTable({
            pagingType: "first_last_numbers",
            processing: true,
            ajax: {
                url: '/reports/discounted',
                data: function(data) {
                    data.month = $("#months_discounted").val();
                },
                dataSrc: 'reportDiscountedList'
            },
            columns: [
                { data: 'No' },
                { data: 'UsageId' },
                { data: 'SupplyNo' },
                { data: 'CustomerName' },
                { data: 'MeterBarcodeNo' },
                { data: 'PrevRead' },
                { data: 'CurrRead' },
                { data: 'UsedKW' },
                { data: 'UnitRate' },
                { data: 'Bill' },
                { data: 'Discounted' },
                { data: 'Biller' },
                { data: 'CreateDate' }
            ],
            dom: 'Bfrtip',
            buttons: ['print', 'excel'],
            "footerCallback": function(row, data, start, end, display) {
                var api = this.api();

                // Total over all pages
                totalPrev = api
                    .column(5)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalCurr = api
                    .column(6)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalUsed = api
                    .column(7)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalBill = api
                    .column(9)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalDiscounted = api
                    .column(10)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                averageUnitRate = parseFloat(totalBill / totalUsed).toFixed(2);
                // Update footer
                $(api.column(5).footer()).html(
                    totalPrev + 'KW'
                );
                $(api.column(6).footer()).html(
                    totalCurr + 'KW'
                );
                $(api.column(7).footer()).html(
                    totalUsed + 'KW'
                );
                $(api.column(8).footer()).html(
                    averageUnitRate
                );
                $(api.column(9).footer()).html(
                    '$' + totalBill
                );
                $(api.column(10).footer()).html(
                    '$' + totalDiscounted
                );
            }
        });
        $('.dataTables_wrapper').css("font-size", "12px");

        //$('.dataTables_length').addClass('bs-select');
    }

    function showUsageTable() {
        usageTable = $('#report_usage_table').DataTable({
            pagingType: "first_last_numbers",
            processing: true,
            ajax: {
                url: '/reports/usage',
                data: function(data) {
                    var month = $("#months_usage").val();
                    //data.month = $("#myMonth").val();
                    data.month = month;
                    data.isread = $("#isread").val();
                },
                dataSrc: 'reportUsageList'
            },
            columns: [
                { data: 'No'},              // 0
                { data: 'SupplyNo' },       // 1
                { data: 'Name' },           // 2
                { data: 'MeterBarcodeNo' }, // 3
                { data: 'PrevReadDate' },   // 4
                { data: 'CurrReadDate' },   // 5
                { data: 'PrevRead' },       // 6
                { data: 'CurrRead' },       // 7
                { data: 'UsedKW' },         // 8
                { data: 'UnitRate' },       // 9
                { data: 'Discounted' },     // 10
                { data: 'Bill' },           // 11
                { data: 'Biller' },         // 12
                { data: 'CreateDate' }      // 13
            ], 
            dom: 'Bfrtip',
            buttons: ['print', 'excel'],
            "footerCallback": function(row, data, start, end, display) {
                var api = this.api();

                // Total over all pages
                totalPrev = api
                    .column(6)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalCurr = api
                    .column(7)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalUsed = api
                    .column(8)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                totalBill = api
                    .column(11)
                    .data()
                    .reduce(function(a, b) {
                        return parseFloat(intVal(a) + intVal(b)).toFixed(2);
                    }, 0);
                averageUnitRate = parseFloat(totalBill / totalUsed).toFixed(2);
                // Update footer
                $(api.column(6).footer()).html(
                    totalPrev + 'KW'
                );
                $(api.column(7).footer()).html(
                    totalCurr + 'KW'
                );
                $(api.column(8).footer()).html(
                    totalUsed + 'KW'
                );
                $(api.column(11).footer()).html(
                    '$' + totalBill
                );
            }
        });
        $('.dataTables_wrapper').css("font-size", "12px");

        //$('.dataTables_length').addClass('bs-select');
    }
    $(document).ready(function() {
        showReportTable();
        showDiscountedTable();
        showUsageTable();
    });

    function onBtnExport_Reports() {
        extractExcel("reports", "reports")
    }

    function onBtnExport_Discounted() {
        extractExcel("report_discounted_table", "discounted(" + $("#months").val() + ")")
    }

    function extractExcel(table_id, filename) {
        var htmltable = document.getElementById(table_id);
        var html = htmltable.outerHTML;
        //var str = "Name, Price\nApple, 2\nOrange, 3";
        var uri = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);

        var downloadLink = document.createElement("a");
        downloadLink.href = uri;
        downloadLink.download = filename;

        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        //var htmltable= document.getElementById('my-table-id');
        //var html = htmltable.outerHTML;
        //window.open('data:application/vnd.ms-excel,' + encodeURIComponent(html));
    }

    function printTableData(table_id) {
        //window.print();
        //return;

        var divToPrint = document.getElementById(table_id);
        var htmlToPrint = '' +
            '<style type="text/css">' +
            'table th, table td {' +
            'border:1px solid #000;' +
            'padding:0.5em;' +
            '}' +
            '</style>';
        htmlToPrint += divToPrint.outerHTML;
        newWin = window.open("");
        newWin.document.write(htmlToPrint);
        newWin.print();
        newWin.close();
        return;
    }
</script>

{% endblock %}